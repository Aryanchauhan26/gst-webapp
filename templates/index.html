<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Intelligence Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/base.css">
</head>
<body class="page-dashboard">
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav__container">
            <a href="/" class="nav__logo">
                <div class="nav__logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>GST Intelligence</span>
            </a>
            
            <div class="nav__links">
                <a href="/" class="nav__link nav__link--active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/history" class="nav__link">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </a>
                <a href="/analytics" class="nav__link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
                <a href="/loans" class="nav__link">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Loans</span>
                </a>
            </div>
            
            <div class="nav__user">
                <button class="user__trigger" id="userMenuTrigger" aria-label="User menu">
                    <div class="user__avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user__name">{{ user_display_name }}</span>
                    <i class="fas fa-chevron-down user__arrow"></i>
                </button>
                
                <div class="user__dropdown" id="userDropdown">
                    <a href="#" class="dropdown__item" data-action="profile">
                        <i class="fas fa-user-edit"></i>
                        <span>Profile</span>
                    </a>
                    <a href="#" class="dropdown__item" data-action="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <a href="#" class="dropdown__item" data-action="theme">
                        <i class="fas fa-moon"></i>
                        <span>Theme</span>
                    </a>
                    <div class="dropdown__divider"></div>
                    <a href="/logout" class="dropdown__item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="welcome__content">
                    <h1 class="welcome__title">
                        Welcome back, <span class="welcome__name">{{ user_display_name }}</span>
                    </h1>
                    <p class="welcome__subtitle">
                        Search and analyze GST data with AI-powered insights
                    </p>
                </div>
                
                <div class="welcome__stats">
                    <div class="stat">
                        <div class="stat__icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="stat__content">
                            <div class="stat__number">{{ searches_this_month }}</div>
                            <div class="stat__label">This Month</div>
                        </div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat__icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="stat__content">
                            <div class="stat__number" id="totalCompanies">-</div>
                            <div class="stat__label">Companies</div>
                        </div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat__icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat__content">
                            <div class="stat__number" id="avgScore">-</div>
                            <div class="stat__label">Avg. Score</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-card">
                    <div class="search-card__header">
                        <h2 class="search-card__title">
                            <i class="fas fa-search"></i>
                            Search GSTIN
                        </h2>
                        <p class="search-card__subtitle">
                            Enter a 15-digit GSTIN to get comprehensive business insights
                        </p>
                    </div>
                    
                    <form class="search-form" id="searchForm" method="post" action="/search">
                        <div class="search-input-group">
                            <input 
                                type="text" 
                                name="gstin" 
                                class="search-input" 
                                placeholder="Enter GSTIN (e.g., 07AABCU9603R1ZX)" 
                                id="gstinInput"
                                maxlength="15"
                                autocomplete="off"
                                required
                            >
                            <button type="submit" class="search-btn" id="searchBtn">
                                <i class="fas fa-search"></i>
                                <span>Search</span>
                            </button>
                        </div>
                        
                        <div class="search-suggestions" id="searchSuggestions"></div>
                        
                        <div class="search-options">
                            <label class="checkbox-option">
                                <input type="checkbox" id="saveSearch" checked>
                                <span class="checkmark"></span>
                                Save to history
                            </label>
                            
                            <label class="checkbox-option">
                                <input type="checkbox" id="aiInsights">
                                <span class="checkmark"></span>
                                Generate AI insights
                            </label>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3 class="section-title">Quick Actions</h3>
                
                <div class="actions-grid">
                    <a href="/analytics" class="action-card">
                        <div class="action-card__icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="action-card__content">
                            <h4 class="action-card__title">View Analytics</h4>
                            <p class="action-card__desc">Detailed insights and trends</p>
                        </div>
                    </a>
                    
                    <a href="/history" class="action-card">
                        <div class="action-card__icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="action-card__content">
                            <h4 class="action-card__title">Search History</h4>
                            <p class="action-card__desc">View past searches</p>
                        </div>
                    </a>
                    
                    <button class="action-card" data-action="export">
                        <div class="action-card__icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="action-card__content">
                            <h4 class="action-card__title">Export Data</h4>
                            <p class="action-card__desc">Download search results</p>
                        </div>
                    </button>
                    
                    <a href="/loans" class="action-card">
                        <div class="action-card__icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="action-card__content">
                            <h4 class="action-card__title">Apply for Loan</h4>
                            <p class="action-card__desc">Quick business loans</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Recent Searches -->
            {% if history %}
            <div class="recent-searches">
                <div class="section-header">
                    <h3 class="section-title">Recent Searches</h3>
                    <a href="/history" class="section-link">
                        View All <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                
                <div class="searches-grid">
                    {% for item in history[:6] %}
                    <div class="search-item" data-gstin="{{ item.gstin }}">
                        <div class="search-item__header">
                            <div class="search-item__gstin">{{ item.gstin }}</div>
                            <div class="search-item__score score-{{ 'high' if item.compliance_score >= 80 else 'medium' if item.compliance_score >= 60 else 'low' }}">
                                {{ item.compliance_score }}%
                            </div>
                        </div>
                        
                        <div class="search-item__content">
                            <h4 class="search-item__company">{{ item.company_name }}</h4>
                            <div class="search-item__status status-{{ item.status.lower() }}">
                                {{ item.status }}
                            </div>
                        </div>
                        
                        <div class="search-item__footer">
                            <div class="search-item__date">
                                {{ item.searched_at.strftime('%d %b') if item.searched_at else 'Recently' }}
                            </div>
                            <button class="search-item__action" onclick="searchAgain('{{ item.gstin }}')">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Searching GSTIN...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/app.js"></script>
    <script src="/static/js/missing-implementations.js"></script>
    <script src="/static/js/integration-fixes.js"></script>
    
    <script>
        // Dashboard specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadUserStats();
            setupSearchForm();
            setupUserMenu();
        });

        function initializeDashboard() {
            // Format GSTIN input
            const gstinInput = document.getElementById('gstinInput');
            if (gstinInput) {
                gstinInput.addEventListener('input', function(e) {
                    let value = e.target.value.toUpperCase().replace(/[^0-9A-Z]/g, '');
                    if (value.length > 15) value = value.substr(0, 15);
                    e.target.value = value;
                    
                    // Show suggestions
                    showSearchSuggestions(value);
                });
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/user/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalCompanies').textContent = data.data.unique_companies;
                    document.getElementById('avgScore').textContent = data.data.avg_compliance + '%';
                }
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }

        function setupSearchForm() {
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    const gstinInput = document.getElementById('gstinInput');
                    const gstin = gstinInput.value.trim();
                    
                    if (!isValidGSTIN(gstin)) {
                        e.preventDefault();
                        if (window.notificationManager) {
                            window.notificationManager.showError('Please enter a valid 15-digit GSTIN');
                        }
                        return;
                    }
                    
                    // Show loading
                    document.getElementById('loadingOverlay').style.display = 'flex';
                });
            }
        }

        function setupUserMenu() {
            const trigger = document.getElementById('userMenuTrigger');
            const dropdown = document.getElementById('userDropdown');
            
            if (trigger && dropdown) {
                trigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    dropdown.classList.toggle('active');
                    trigger.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    dropdown.classList.remove('active');
                    trigger.classList.remove('active');
                });
                
                // Handle dropdown actions
                dropdown.addEventListener('click', function(e) {
                    const action = e.target.closest('[data-action]')?.dataset.action;
                    if (action) {
                        e.preventDefault();
                        handleUserAction(action);
                    }
                });
            }
        }

        function handleUserAction(action) {
            switch (action) {
                case 'profile':
                    if (window.openEnhancedProfileModal) {
                        window.openEnhancedProfileModal();
                    }
                    break;
                case 'settings':
                    if (window.openSettingsModal) {
                        window.openSettingsModal();
                    }
                    break;
                case 'theme':
                    if (window.themeManager) {
                        window.themeManager.toggleTheme();
                    }
                    break;
                case 'export':
                    exportSearchHistory();
                    break;
            }
        }

        function showSearchSuggestions(query) {
            // Simple suggestion logic
            const suggestionsDiv = document.getElementById('searchSuggestions');
            if (!suggestionsDiv || query.length < 2) {
                if (suggestionsDiv) suggestionsDiv.innerHTML = '';
                return;
            }
            
            // Clear suggestions for now - can be enhanced with API
            suggestionsDiv.innerHTML = '';
        }

        function searchAgain(gstin) {
            document.getElementById('gstinInput').value = gstin;
            document.getElementById('searchForm').submit();
        }

        async function exportSearchHistory() {
            try {
                const response = await fetch('/api/user/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ format: 'csv' })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'search_history.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    if (window.notificationManager) {
                        window.notificationManager.showSuccess('Search history exported successfully');
                    }
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                if (window.notificationManager) {
                    window.notificationManager.showError('Failed to export search history');
                }
            }
        }

        // Global GSTIN validation function
        function isValidGSTIN(gstin) {
            if (!gstin || gstin.length !== 15) return false;
            const pattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            return pattern.test(gstin);
        }
    </script>
</body>
</html>