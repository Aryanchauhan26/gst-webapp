<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GST Intelligence Platform - Advanced GST compliance analytics and business loan management">
    <meta name="keywords" content="GST, compliance, analytics, business loans, India, tax, GSTIN">
    <meta name="author" content="GST Intelligence Platform">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GST Intelligence">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    
    <title>{% block title %}GST Intelligence Platform{% endblock %}</title>
    
    <!-- Core Styles -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Block for additional styles -->
    {% block extra_css %}{% endblock %}
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/js/app.js" as="script">
    <link rel="preload" href="/static/css/base.css" as="style">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "GST Intelligence Platform",
        "description": "Advanced GST compliance analytics and business loan management platform",
        "url": "{{ request.url_root }}",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web Browser"
    }
    </script>
</head>
<body class="{% block body_class %}{% endblock %}">
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <!-- Logo and Brand -->
            <div class="navbar-brand">
                <a href="/" class="brand-link" aria-label="GST Intelligence Platform Home">
                    <div class="brand-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="brand-text">GST Intelligence</span>
                </a>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="navbar-toggle" type="button" aria-label="Toggle navigation menu" aria-expanded="false">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <!-- Navigation Links -->
            <div class="navbar-menu">
                <div class="navbar-nav">
                    <a href="/" class="nav-link {{ 'active' if request.endpoint == 'dashboard' else '' }}">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/history" class="nav-link {{ 'active' if request.endpoint == 'history_page' else '' }}">
                        <i class="fas fa-history"></i>
                        <span>History</span>
                    </a>
                    <a href="/analytics" class="nav-link {{ 'active' if request.endpoint == 'analytics_page' else '' }}">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="/loans" class="nav-link {{ 'active' if request.endpoint == 'loans_page' else '' }}">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Loans</span>
                    </a>
                </div>
                
                <!-- User Menu -->
                <div class="navbar-user">
                    <div class="user-menu-trigger" role="button" tabindex="0" aria-label="User menu">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name">{{ user_display_name or 'User' }}</span>
                        <i class="fas fa-chevron-down user-menu-arrow"></i>
                    </div>
                    
                    <!-- User Dropdown Menu -->
                    <div class="user-dropdown" role="menu">
                        <div class="dropdown-header">
                            <div class="user-info">
                                <div class="user-name-display">{{ user_display_name or 'User' }}</div>
                                <div class="user-mobile">{{ current_user }}</div>
                            </div>
                        </div>
                        
                        <div class="dropdown-divider"></div>
                        
                        <a href="#" class="dropdown-item" role="menuitem" data-action="profile">
                            <i class="fas fa-user-edit"></i>
                            <span>Profile Settings</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" role="menuitem" data-action="preferences">
                            <i class="fas fa-cog"></i>
                            <span>Preferences</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" role="menuitem" data-action="export">
                            <i class="fas fa-download"></i>
                            <span>Export Data</span>
                        </a>
                        
                        {% if current_user in admin_users %}
                        <div class="dropdown-divider"></div>
                        <a href="/admin" class="dropdown-item" role="menuitem">
                            <i class="fas fa-shield-alt"></i>
                            <span>Admin Panel</span>
                        </a>
                        {% endif %}
                        
                        <div class="dropdown-divider"></div>
                        
                        <a href="/logout" class="dropdown-item logout-item" role="menuitem">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content" role="main">
        <!-- Page Header -->
        {% block page_header %}{% endblock %}
        
        <!-- Flash Messages / Notifications -->
        <div id="flash-messages" class="flash-messages" aria-live="polite"></div>
        
        <!-- Page Content -->
        <div class="content-wrapper">
            {% block content %}{% endblock %}
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer" role="contentinfo">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>GST Intelligence Platform</h3>
                    <p>Advanced GST compliance analytics and business loan management for Indian businesses.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Features</h4>
                    <ul>
                        <li><a href="/">GST Search & Analysis</a></li>
                        <li><a href="/loans">Business Loans</a></li>
                        <li><a href="/analytics">Compliance Analytics</a></li>
                        <li><a href="/history">Search History</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="/help">Help Center</a></li>
                        <li><a href="/contact">Contact Us</a></li>
                        <li><a href="/privacy">Privacy Policy</a></li>
                        <li><a href="/terms">Terms of Service</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Connect</h4>
                    <div class="social-links">
                        <a href="#" aria-label="Follow us on Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Follow us on LinkedIn"><i class="fab fa-linkedin"></i></a>
                        <a href="#" aria-label="Like us on Facebook"><i class="fab fa-facebook"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p>&copy; {{ current_year or 2024 }} GST Intelligence Platform. All rights reserved.</p>
                    <div class="footer-links">
                        <a href="/health">System Status</a>
                        <span class="divider">|</span>
                        <a href="/api-docs">API Documentation</a>
                        <span class="divider">|</span>
                        <span class="version">v2.0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Modals Container -->
    <div id="modals-container"></div>
    
    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal" role="dialog" aria-labelledby="profile-modal-title" aria-hidden="true">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="profile-modal-title">Profile Settings</h2>
                <button type="button" class="modal-close" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="display_name">Display Name</label>
                        <input type="text" id="display_name" name="display_name" placeholder="Your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="company">Company</label>
                        <input type="text" id="company" name="company" placeholder="Your company name">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="your.email@company.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="designation">Designation</label>
                        <input type="text" id="designation" name="designation" placeholder="Your job title">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" form="profile-form" class="btn btn--primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Preferences Modal -->
    <div id="preferences-modal" class="modal" role="dialog" aria-labelledby="preferences-modal-title" aria-hidden="true">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="preferences-modal-title">User Preferences</h2>
                <button type="button" class="modal-close" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="preferences-form">
                    <div class="preferences-section">
                        <h3>Notifications</h3>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="emailNotifications">
                                <span class="checkbox-custom"></span>
                                Email notifications for important updates
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="pushNotifications">
                                <span class="checkbox-custom"></span>
                                Browser push notifications
                            </label>
                        </div>
                    </div>
                    
                    <div class="preferences-section">
                        <h3>Application</h3>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="autoSearch" checked>
                                <span class="checkbox-custom"></span>
                                Enable auto-search suggestions
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="animations" checked>
                                <span class="checkbox-custom"></span>
                                Enable animations and transitions
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="saveHistory" checked>
                                <span class="checkbox-custom"></span>
                                Save search history
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" form="preferences-form" class="btn btn--primary">Save Preferences</button>
            </div>
        </div>
    </div>
    
    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" class="pwa-prompt" style="display: none;">
        <div class="pwa-prompt-content">
            <div class="pwa-prompt-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="pwa-prompt-text">
                <h3>Install GST Intelligence</h3>
                <p>Add to your home screen for quick access</p>
            </div>
            <div class="pwa-prompt-actions">
                <button type="button" class="btn btn--secondary" id="pwa-dismiss">Not Now</button>
                <button type="button" class="btn btn--primary" id="pwa-install">Install</button>
            </div>
        </div>
    </div>
    
    <!-- Core JavaScript -->
    <script>
        // Global configuration
        window.GST_CONFIG = {
            currentUser: '{{ current_user }}',
            userName: '{{ user_display_name or "User" }}',
            csrfToken: '{{ csrf_token() if csrf_token else "" }}',
            apiBaseUrl: '{{ request.url_root }}',
            isAuthenticated: {{ 'true' if current_user else 'false' }},
            features: {
                loans: {{ 'true' if loan_management_enabled else 'false' }},
                ai: {{ 'true' if ai_features_enabled else 'false' }},
                analytics: true
            }
        };
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // PWA Install Prompt Handler
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installPrompt = document.getElementById('pwa-install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'block';
            }
        });
        
        // Modal System
        window.ModalSystem = {
            open: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('modal-open');
                    
                    // Focus first focusable element
                    const firstFocusable = modal.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) {
                        firstFocusable.focus();
                    }
                }
            },
            
            close: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('modal-open');
                }
            }
        };
        
        // User Menu Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const userMenuTrigger = document.querySelector('.user-menu-trigger');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userMenuTrigger && userDropdown) {
                userMenuTrigger.addEventListener('click', function() {
                    userDropdown.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuTrigger.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('active');
                    }
                });
            }
            
            // Mobile menu toggle
            const navbarToggle = document.querySelector('.navbar-toggle');
            const navbarMenu = document.querySelector('.navbar-menu');
            
            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function() {
                    const isExpanded = navbarToggle.getAttribute('aria-expanded') === 'true';
                    navbarToggle.setAttribute('aria-expanded', !isExpanded);
                    navbarMenu.classList.toggle('active');
                });
            }
            
            // Dropdown item handlers
            document.addEventListener('click', function(e) {
                const item = e.target.closest('.dropdown-item[data-action]');
                if (item) {
                    e.preventDefault();
                    const action = item.dataset.action;
                    
                    switch (action) {
                        case 'profile':
                            window.ModalSystem.open('profile-modal');
                            break;
                        case 'preferences':
                            window.ModalSystem.open('preferences-modal');
                            break;
                        case 'export':
                            window.location.href = '/export/history';
                            break;
                    }
                }
            });
            
            // Modal close handlers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay') || 
                    e.target.classList.contains('modal-close') ||
                    e.target.closest('.modal-close')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        window.ModalSystem.close(modal.id);
                    }
                }
                
                if (e.target.hasAttribute('data-dismiss') && e.target.dataset.dismiss === 'modal') {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        window.ModalSystem.close(modal.id);
                    }
                }
            });
            
            // PWA Install handlers
            const pwaInstallBtn = document.getElementById('pwa-install');
            const pwaDismissBtn = document.getElementById('pwa-dismiss');
            const pwaPrompt = document.getElementById('pwa-install-prompt');
            
            if (pwaInstallBtn) {
                pwaInstallBtn.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted the A2HS prompt');
                            }
                            deferredPrompt = null;
                            pwaPrompt.style.display = 'none';
                        });
                    }
                });
            }
            
            if (pwaDismissBtn) {
                pwaDismissBtn.addEventListener('click', function() {
                    pwaPrompt.style.display = 'none';
                    deferredPrompt = null;
                });
            }
        });
        
        // Error Reporting Function
        window.reportError = function(errorData) {
            fetch('/api/system/error', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(errorData)
            }).catch(function(err) {
                console.error('Failed to report error:', err);
            });
        };
        
        // Loading Overlay
        window.showLoading = function() {
            document.getElementById('loading-overlay').style.display = 'flex';
        };
        
        window.hideLoading = function() {
            document.getElementById('loading-overlay').style.display = 'none';
        };
    </script>
    
    <!-- Application JavaScript -->
    <script src="/static/js/app.js"></script>
    <script src="/static/js/integration-fixes.js"></script>
    <script src="/static/js/missing-implementations.js"></script>
    
    <!-- Block for additional scripts -->
    {% block extra_js %}{% endblock %}
    
    <!-- Performance monitoring -->
    <script>
        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }
        });
    </script>
</body>
</html>