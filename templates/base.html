<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GST Intelligence Platform - Advanced GST compliance analytics and business loan management">
    <meta name="keywords" content="GST, compliance, analytics, business loans, India, tax, GSTIN">
    <meta name="author" content="GST Intelligence Platform">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GST Intelligence">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    
    <title>{% block title %}GST Intelligence Platform{% endblock %}</title>
    
    <!-- Core Styles -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
.flash-messages {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.flash-message {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    margin-bottom: 10px;
    border-left: 4px solid;
    animation: slideIn 0.3s ease-out;
}

.flash-message--success {
    border-left-color: #10b981;
}

.flash-message--error {
    border-left-color: #ef4444;
}

.flash-message--warning {
    border-left-color: #f59e0b;
}

.flash-message--info {
    border-left-color: #3b82f6;
}

.flash-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
}

.flash-text {
    flex: 1;
    color: #374151;
    font-size: 14px;
}

.flash-close {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 4px;
    margin-left: 12px;
}

.flash-close:hover {
    color: #374151;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Skip link styling */
.skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: #000;
    color: #fff;
    padding: 8px;
    text-decoration: none;
    z-index: 10001;
}

.skip-link:focus {
    top: 6px;
}

/* Loading overlay improvements */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-spinner {
    text-align: center;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f4f6;
    border-top: 3px solid #7c3aed;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
    
    <!-- Block for additional styles -->
    {% block extra_css %}{% endblock %}
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/js/app.js" as="script">
    <link rel="preload" href="/static/css/base.css" as="style">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "GST Intelligence Platform",
        "description": "Advanced GST compliance analytics and business loan management platform",
        "url": "{{ request.url_root }}",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web Browser"
    }
    </script>
</head>
<body class="{% block body_class %}{% endblock %}">
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>
    
    <!-- Advanced Navigation Component -->
    {% include 'components/nav.html' %}
    
    <!-- Main Content -->
    <main id="main-content" class="main-content" role="main">
        <!-- Page Header -->
        {% block page_header %}{% endblock %}
        
        <!-- Flash Messages / Notifications -->
        <div id="flash-messages" class="flash-messages" aria-live="polite"></div>
        
        <!-- Page Content -->
        <div class="content-wrapper">
            {% block content %}{% endblock %}
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer" role="contentinfo">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>GST Intelligence Platform</h3>
                    <p>Advanced GST compliance analytics and business loan management for Indian businesses.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Features</h4>
                    <ul>
                        <li><a href="/">GST Search & Analysis</a></li>
                        <li><a href="/loans">Business Loans</a></li>
                        <li><a href="/analytics">Compliance Analytics</a></li>
                        <li><a href="/history">Search History</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="/help">Help Center</a></li>
                        <li><a href="/contact">Contact Us</a></li>
                        <li><a href="/privacy">Privacy Policy</a></li>
                        <li><a href="/terms">Terms of Service</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Connect</h4>
                    <div class="social-links">
                        <a href="#" aria-label="Follow us on Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Follow us on LinkedIn"><i class="fab fa-linkedin"></i></a>
                        <a href="#" aria-label="Like us on Facebook"><i class="fab fa-facebook"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p>&copy; {{ current_year or 2024 }} GST Intelligence Platform. All rights reserved.</p>
                    <div class="footer-links">
                        <a href="/health">System Status</a>
                        <span class="divider">|</span>
                        <a href="/api-docs">API Documentation</a>
                        <span class="divider">|</span>
                        <span class="version">v2.0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Modals Container -->
    <div id="modals-container"></div>
    
    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal" role="dialog" aria-labelledby="profile-modal-title" aria-hidden="true">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="profile-modal-title">Profile Settings</h2>
                <button type="button" class="modal-close" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="display_name">Display Name</label>
                        <input type="text" id="display_name" name="display_name" placeholder="Your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="company">Company</label>
                        <input type="text" id="company" name="company" placeholder="Your company name">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="your.email@company.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="designation">Designation</label>
                        <input type="text" id="designation" name="designation" placeholder="Your job title">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" form="profile-form" class="btn btn--primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Preferences Modal -->
    <div id="preferences-modal" class="modal" role="dialog" aria-labelledby="preferences-modal-title" aria-hidden="true">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="preferences-modal-title">User Preferences</h2>
                <button type="button" class="modal-close" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="preferences-form">
                    <div class="preferences-section">
                        <h3>Notifications</h3>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="emailNotifications">
                                <span class="checkbox-custom"></span>
                                Email notifications for important updates
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="pushNotifications">
                                <span class="checkbox-custom"></span>
                                Browser push notifications
                            </label>
                        </div>
                    </div>
                    
                    <div class="preferences-section">
                        <h3>Application</h3>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="autoSearch" checked>
                                <span class="checkbox-custom"></span>
                                Enable auto-search suggestions
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="animations" checked>
                                <span class="checkbox-custom"></span>
                                Enable animations and transitions
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="saveHistory" checked>
                                <span class="checkbox-custom"></span>
                                Save search history
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" form="preferences-form" class="btn btn--primary">Save Preferences</button>
            </div>
        </div>
    </div>
    
    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" class="pwa-prompt" style="display: none;">
        <div class="pwa-prompt-content">
            <div class="pwa-prompt-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="pwa-prompt-text">
                <h3>Install GST Intelligence</h3>
                <p>Add to your home screen for quick access</p>
            </div>
            <div class="pwa-prompt-actions">
                <button type="button" class="btn btn--secondary" id="pwa-dismiss">Not Now</button>
                <button type="button" class="btn btn--primary" id="pwa-install">Install</button>
            </div>
        </div>
    </div>
    
    <!-- Core JavaScript -->
    <script>
        // Global configuration
        window.GST_CONFIG = {
            currentUser: '{{ current_user or "" }}',
            userName: '{{ user_display_name or "User" }}',
            apiBaseUrl: '{{ request.url_root or "/" }}',
            isAuthenticated: {{ 'true' if current_user else 'false' }},
            features: {
                loans: {{ 'true' if loan_management_enabled else 'false' }},
                ai: {{ 'true' if ai_features_enabled else 'false' }},
                analytics: true
            },
            adminUsers: {{ admin_users | tojson if admin_users else '[]' }},
            currentYear: {{ current_year or 2024 }}
    };
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // PWA Install Prompt Handler
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installPrompt = document.getElementById('pwa-install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'block';
            }
        });
        
        // Modal System
        window.ModalSystem = {
            open: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('modal-open');
                    
                    // Focus first focusable element
                    const firstFocusable = modal.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) {
                        firstFocusable.focus();
                    }
                }
            },
            
            close: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('modal-open');
                }
            }
        };
            
            // Modal close handlers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay') || 
                    e.target.classList.contains('modal-close') ||
                    e.target.closest('.modal-close')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        window.ModalSystem.close(modal.id);
                    }
                }
                
                if (e.target.hasAttribute('data-dismiss') && e.target.dataset.dismiss === 'modal') {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        window.ModalSystem.close(modal.id);
                    }
                }
            });
            
            // PWA Install handlers
            const pwaInstallBtn = document.getElementById('pwa-install');
            const pwaDismissBtn = document.getElementById('pwa-dismiss');
            const pwaPrompt = document.getElementById('pwa-install-prompt');
            
            if (pwaInstallBtn) {
                pwaInstallBtn.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted the A2HS prompt');
                            }
                            deferredPrompt = null;
                            pwaPrompt.style.display = 'none';
                        });
                    }
                });
            }
            
            if (pwaDismissBtn) {
                pwaDismissBtn.addEventListener('click', function() {
                    pwaPrompt.style.display = 'none';
                    deferredPrompt = null;
                });
            };
        
        // Error Reporting Function
        window.reportError = function(errorData) {
            fetch('/api/system/error', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(errorData)
            }).catch(function(err) {
                console.error('Failed to report error:', err);
            });
        };
        
        // Loading Overlay
        window.showLoading = function() {
            document.getElementById('loading-overlay').style.display = 'flex';
        };
        
        window.hideLoading = function() {
            document.getElementById('loading-overlay').style.display = 'none';
        };

        // Flash message system
window.showFlashMessage = function(message, type = 'info') {
    const flashContainer = document.getElementById('flash-messages');
    if (flashContainer) {
        const messageEl = document.createElement('div');
        messageEl.className = `flash-message flash-message--${type}`;
        messageEl.innerHTML = `
            <div class="flash-content">
                <span class="flash-text">${message}</span>
                <button type="button" class="flash-close" aria-label="Close message">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        flashContainer.appendChild(messageEl);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.remove();
            }
        }, 5000);
        
        // Manual close handler
        messageEl.querySelector('.flash-close').addEventListener('click', () => {
            messageEl.remove();
        });
    }
};

// Check for URL parameters on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('registered') === 'true') {
        window.showFlashMessage('Registration successful! Welcome to GST Intelligence Platform.', 'success');
    }
    
    if (urlParams.get('login') === 'success') {
        window.showFlashMessage('Login successful! Welcome back.', 'success');
    }
});
    </script>
    
    <!-- Application JavaScript -->
    <script src="/static/js/app.js"></script>
    <script src="/static/js/integration-fixes.js"></script>
    <script src="/static/js/missing-implementations.js"></script>
    
    <!-- Block for additional scripts -->
    {% block extra_js %}{% endblock %}
    
    <!-- Performance monitoring -->
    <script>
        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }
        });

        // Helper function for display names
window.getUserDisplayName = async function(mobile) {
    try {
        const response = await fetch('/api/user/profile');
        if (response.ok) {
            const data = await response.json();
            return data.display_name || mobile;
        }
    } catch (e) {
        console.log('Could not fetch display name');
    }
    return mobile;
};

// Form submission handlers
document.addEventListener('DOMContentLoaded', function() {
    // Profile form handler
    const profileForm = document.getElementById('profile-form');
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(profileForm);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    window.ModalSystem.close('profile-modal');
                    location.reload(); // Refresh to show updated name
                } else {
                    alert('Failed to update profile');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        });
    }
    
    // Preferences form handler
    const preferencesForm = document.getElementById('preferences-form');
    if (preferencesForm) {
        preferencesForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(preferencesForm);
            const preferences = {};
            
            // Get checkbox values
            const checkboxes = preferencesForm.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                preferences[checkbox.name] = checkbox.checked;
            });
            
            try {
                const response = await fetch('/api/user/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(preferences)
                });
                
                if (response.ok) {
                    window.ModalSystem.close('preferences-modal');
                    alert('Preferences saved successfully');
                } else {
                    alert('Failed to save preferences');
                }
            } catch (error) {
                alert('Error saving preferences');
            }
        });
    }
});
    </script>
</body>
</html>