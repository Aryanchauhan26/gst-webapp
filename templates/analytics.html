{% extends "base.html" %}

{% block title %}Analytics - GST Intelligence Platform{% endblock %}
{% block body_class %}page-analytics{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Page Header -->
    <div class="analytics-header">
        <h1 class="analytics-title">
            <i class="fas fa-chart-bar"></i>
            Analytics Dashboard
        </h1>
        <p class="analytics-subtitle">Comprehensive insights into your GST compliance searches</p>
    </div>

    <!-- Analytics Stats -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Total Searches</span>
                <div class="stat-card-icon searches">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="stat-card-value" id="totalSearches">{{ (history|length) if history else 0 }}</div>
            <div class="stat-card-change neutral">
                <i class="fas fa-chart-line"></i>
                All time activity
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Unique Companies</span>
                <div class="stat-card-icon companies">
                    <i class="fas fa-building"></i>
                </div>
            </div>
            <div class="stat-card-value" id="uniqueCompanies">{{ stats.unique_companies if stats else 0 }}</div>
            <div class="stat-card-change positive">
                <i class="fas fa-arrow-up"></i>
                Businesses analyzed
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Avg Compliance</span>
                <div class="stat-card-icon compliance">
                    <i class="fas fa-shield-alt"></i>
                </div>
            </div>
            <div class="stat-card-value" id="avgCompliance">{{ stats.avg_compliance if stats else 0 }}%</div>
            <div class="stat-card-change {{ 'positive' if (stats.avg_compliance if stats else 0) >= 75 else 'neutral' if (stats.avg_compliance if stats else 0) >= 50 else 'negative' }}">
                <i class="fas fa-{{ 'check' if (stats.avg_compliance if stats else 0) >= 75 else 'minus' if (stats.avg_compliance if stats else 0) >= 50 else 'exclamation' }}"></i>
                Average score
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Recent Activity</span>
                <div class="stat-card-icon activity">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div class="stat-card-value" id="recentActivity">{{ searches_this_month if searches_this_month else 0 }}</div>
            <div class="stat-card-change neutral">
                <i class="fas fa-calendar-day"></i>
                This month
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <!-- Search Trends Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Search Trends</h3>
                <div class="chart-controls">
                    <button class="chart-control-btn active" data-period="7d">7 Days</button>
                    <button class="chart-control-btn" data-period="30d">30 Days</button>
                    <button class="chart-control-btn" data-period="90d">90 Days</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="searchTrendsChart"></canvas>
            </div>
        </div>
        
        <!-- Top Companies Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Top Companies</h3>
            </div>
            <div class="chart-container">
                <canvas id="topCompaniesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    {% if history %}
    <div class="analytics-activity">
        <h2>Recent Search Activity</h2>
        <div class="activity-list">
            {% for item in history[:10] %}
            <div class="activity-item">
                <div class="activity-gstin">{{ item.gstin }}</div>
                <div class="activity-company">{{ item.company_name or 'Unknown Company' }}</div>
                <div class="activity-score">{{ item.compliance_score or 0 }}%</div>
                <div class="activity-date">
                    {% if item.searched_at %}
                        {{ item.searched_at.strftime('%d %b') }}
                    {% else %}
                        Recent
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-chart-bar"></i>
        <h3>No Analytics Data</h3>
        <p>Start searching for companies to see analytics</p>
        <a href="/" class="btn-primary">Start Searching</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.analytics-header {
    text-align: center;
    margin-bottom: 3rem;
}

.analytics-title {
    font-size: 2.5rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.analytics-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-card-title {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.stat-card-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.stat-card-icon.searches { background: var(--accent-primary); }
.stat-card-icon.companies { background: var(--success); }
.stat-card-icon.compliance { background: var(--warning); }
.stat-card-icon.activity { background: var(--info); }

.stat-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.stat-card-change {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.stat-card-change.positive { color: var(--success); }
.stat-card-change.negative { color: var(--error); }
.stat-card-change.neutral { color: var(--text-secondary); }

.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary);
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-control-btn {
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.chart-control-btn.active,
.chart-control-btn:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.chart-container {
    position: relative;
    height: 300px;
}

.analytics-activity {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 2rem;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.activity-gstin {
    font-family: monospace;
    font-weight: 600;
    color: var(--accent-primary);
}

.activity-company {
    color: var(--text-secondary);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.btn-primary {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--accent-primary);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
}

@media (max-width: 768px) {
    .analytics-container {
        padding: 1rem;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
let searchTrendsChart = null;
let topCompaniesChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeAnalytics();
});

async function initializeAnalytics() {
    try {
        await loadAnalyticsData();
        setupChartControls();
        generateInsights();
    } catch (error) {
        console.error('Analytics initialization failed:', error);
    }
}

async function loadAnalyticsData() {
    try {
        const response = await fetch('/api/user/analytics');
        const data = await response.json();
        
        if (data.success) {
            updateStats(data.stats);
            createSearchTrendsChart(data.daily_searches || []);
            createTopCompaniesChart(data.top_companies || []);
        } else {
            throw new Error(data.error || 'Failed to load analytics');
        }
    } catch (error) {
        console.error('Analytics data loading failed:', error);
        createFallbackCharts();
    }
}

function createSearchTrendsChart(dailySearches) {
    const ctx = document.getElementById('searchTrendsChart');
    if (!ctx) return;
    
    if (searchTrendsChart) {
        searchTrendsChart.destroy();
    }
    
    const labels = dailySearches.map(item => new Date(item.date).toLocaleDateString());
    const data = dailySearches.map(item => item.count);
    
    searchTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Searches',
                data: data,
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createTopCompaniesChart(topCompanies) {
    const ctx = document.getElementById('topCompaniesChart');
    if (!ctx) return;
    
    if (topCompaniesChart) {
        topCompaniesChart.destroy();
    }
    
    const labels = topCompanies.slice(0, 5).map(item => 
        item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name
    );
    const data = topCompanies.slice(0, 5).map(item => item.count);
    
    topCompaniesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(236, 72, 153, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createFallbackCharts() {
    createSearchTrendsChart([]);
    createTopCompaniesChart([]);
}

function setupChartControls() {
    const controls = document.querySelectorAll('.chart-control-btn');
    controls.forEach(btn => {
        btn.addEventListener('click', function() {
            controls.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            loadChartData(period);
        });
    });
}

async function loadChartData(period) {
    try {
        const response = await fetch(`/api/user/analytics?period=${period}`);
        const data = await response.json();
        
        if (data.success) {
            createSearchTrendsChart(data.daily_searches || []);
        }
    } catch (error) {
        console.error('Failed to load chart data:', error);
    }
}

function updateStats(stats) {
    if (stats) {
        document.getElementById('recentActivity').textContent = stats.recent_activity || 0;
    }
}

function generateInsights() {
    // Placeholder insights
    console.log('Analytics insights generated');
}
</script>
{% endblock %}