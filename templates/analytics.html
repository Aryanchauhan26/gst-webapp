{% extends "base.html" %}

{% block title %}Analytics - GST Intelligence Platform{% endblock %}
{% block body_class %}page-analytics{% endblock %}

{% block content %}
<main class="container">
    <!-- Live Indicator -->
    <div class="live-indicator">
        <div class="live-dot"></div>
        <span>Live Analytics</span>
        <div class="last-updated" id="lastUpdated">
            Updated just now
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card" data-stat="total-searches">
            <div class="stat-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ total_searches or 0 }}</div>
                <div class="stat-label">Total Searches</div>
                <div class="stat-change positive">+{{ searches_this_month or 0 }} this month</div>
            </div>
        </div>

        <div class="stat-card" data-stat="unique-companies">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ unique_companies or 0 }}</div>
                <div class="stat-label">Unique Companies</div>
                <div class="stat-change neutral">Companies analyzed</div>
            </div>
        </div>

        <div class="stat-card" data-stat="avg-compliance">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ avg_compliance or 0 }}%</div>
                <div class="stat-label">Avg Compliance</div>
                <div class="stat-change {{ 'positive' if (avg_compliance or 0) >= 75 else 'neutral' }}">
                    {{ 'Excellent' if (avg_compliance or 0) >= 90 else 'Good' if (avg_compliance or 0) >= 75 else 'Average' }}
                </div>
            </div>
        </div>

        <div class="stat-card" data-stat="searches-monthly">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ searches_this_month or 0 }}</div>
                <div class="stat-label">This Month</div>
                <div class="stat-change positive">{{ ((searches_this_month or 0) / 30) | round(1) }}/day avg</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Search Trends Chart -->
        <div class="chart-card card--glass glow-md">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Search Trends
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn active" data-period="7d">7D</button>
                    <button class="chart-btn" data-period="30d">30D</button>
                    <button class="chart-btn" data-period="90d">90D</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <!-- Compliance Distribution Chart -->
        <div class="chart-card card--glass glow-md">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Compliance Distribution
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
                <div class="chart-legend">
                    <div class="legend-item excellent">Excellent (90-100%)</div>
                    <div class="legend-item good">Good (70-89%)</div>
                    <div class="legend-item average">Average (50-69%)</div>
                    <div class="legend-item poor">Poor (<50%)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Companies Section -->
    <div class="chart-card card--glass glow-md">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="fas fa-trophy"></i>
                Top Searched Companies
            </h3>
        </div>
        <div class="companies-list">
            {% if top_companies %}
                {% for company in top_companies %}
                <div class="company-row" data-gstin="{{ company.gstin }}" onclick="searchCompany('{{ company.gstin }}')">
                    <div class="company-info">
                        <div class="company-name">{{ company.company_name }}</div>
                        <div class="company-gstin">{{ company.gstin }}</div>
                    </div>
                    <div class="company-stats">
                        <div class="search-count">
                            <i class="fas fa-search"></i>
                            {{ company.search_count }} searches
                        </div>
                        <div class="compliance-score">
                            <div class="score-badge score-{{ 'excellent' if company.latest_score >= 90 else 'good' if company.latest_score >= 70 else 'average' }}">
                                {{ company.latest_score or 'N/A' }}{{ '%' if company.latest_score else '' }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>No search data available yet. Start searching companies to see analytics!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Insights Panel -->
    <div class="insights-panel">
        <div class="insight-card">
            <div class="insight-icon">
                <i class="fas fa-lightbulb"></i>
            </div>
            <div class="insight-content">
                <h4>Smart Insights</h4>
                <ul>
                    {% if avg_compliance >= 80 %}
                    <li>‚úÖ Your searches focus on high-compliance companies</li>
                    {% elif avg_compliance >= 60 %}
                    <li>‚ö†Ô∏è Mixed compliance in your search history</li>
                    {% else %}
                    <li>üîç Consider focusing on higher compliance companies</li>
                    {% endif %}
                    
                    {% if searches_this_month >= 20 %}
                    <li>üöÄ High search activity this month</li>
                    {% elif searches_this_month >= 5 %}
                    <li>üìä Moderate search activity</li>
                    {% else %}
                    <li>üí° Explore more companies to gain insights</li>
                    {% endif %}
                    
                    {% if unique_companies >= 10 %}
                    <li>üéØ Good diversity in company research</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</main>

<!-- Hidden data containers for JavaScript -->
<script type="application/json" id="analytics-data">
{
    "daily_searches": {{ daily_searches | tojson | safe if daily_searches else '[]' }},
    "score_distribution": {{ score_distribution | tojson | safe if score_distribution else '[]' }},
    "top_companies": {{ top_companies | tojson | safe if top_companies else '[]' }}
}
</script>
{% endblock %}

{% block extra_js %}
<script>
// FIXED Analytics Dashboard - Complete rewrite for reliability
class AnalyticsDashboard {
    constructor() {
        this.charts = {};
        this.data = null;
        this.isInitialized = false;
        
        console.log('üìä Analytics Dashboard initializing...');
        this.init();
    }

    async init() {
        try {
            // Wait for DOM to be fully ready
            if (document.readyState !== 'complete') {
                await new Promise(resolve => {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', resolve);
                    } else {
                        resolve();
                    }
                });
            }

            // Wait for Chart.js to be available
            await this.waitForChartJS();
            
            // Load and validate data
            this.loadData();
            
            // Configure Chart.js defaults
            this.configureChartDefaults();
            
            // Initialize charts
            await this.initializeCharts();
            
            // Setup controls and interactions
            this.setupControls();
            this.setupCompanyInteractions();
            
            // Update timestamps
            this.updateTimestamps();
            setInterval(() => this.updateTimestamps(), 30000);
            
            this.isInitialized = true;
            console.log('‚úÖ Analytics Dashboard initialized successfully');
            
        } catch (error) {
            console.error('‚ùå Analytics Dashboard initialization failed:', error);
            this.showError('Failed to initialize analytics dashboard');
        }
    }

    async waitForChartJS() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max wait
            
            const checkChartJS = () => {
                if (typeof Chart !== 'undefined') {
                    console.log('‚úÖ Chart.js is available');
                    resolve();
                } else if (attempts >= maxAttempts) {
                    reject(new Error('Chart.js failed to load after 5 seconds'));
                } else {
                    attempts++;
                    setTimeout(checkChartJS, 100);
                }
            };
            
            checkChartJS();
        });
    }

    loadData() {
        try {
            // Get data from JSON script tag
            const dataElement = document.getElementById('analytics-data');
            if (dataElement) {
                this.data = JSON.parse(dataElement.textContent);
                console.log('üìä Analytics data loaded:', this.data);
            } else {
                console.warn('‚ö†Ô∏è No analytics data found, using empty data');
                this.data = {
                    daily_searches: [],
                    score_distribution: [],
                    top_companies: []
                };
            }
        } catch (error) {
            console.error('‚ùå Error loading analytics data:', error);
            this.data = {
                daily_searches: [],
                score_distribution: [],
                top_companies: []
            };
        }
    }

    configureChartDefaults() {
        // Get CSS custom properties for theming
        const rootStyles = getComputedStyle(document.documentElement);
        const textColor = rootStyles.getPropertyValue('--text-secondary').trim() || '#94a3b8';
        const borderColor = rootStyles.getPropertyValue('--border-primary').trim() || '#334155';
        
        // Configure Chart.js defaults
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = borderColor;
        Chart.defaults.backgroundColor = 'rgba(124, 58, 237, 0.1)';
        Chart.defaults.font.family = 'Inter, -apple-system, BlinkMacSystemFont, sans-serif';
        Chart.defaults.font.size = 12;
        
        console.log('üé® Chart.js defaults configured');
    }

    async initializeCharts() {
        try {
            await Promise.all([
                this.initTrendsChart(),
                this.initDistributionChart()
            ]);
            console.log('üìà All charts initialized');
        } catch (error) {
            console.error('‚ùå Chart initialization failed:', error);
            this.showChartError();
        }
    }

    async initTrendsChart() {
        const canvas = document.getElementById('trendsChart');
        if (!canvas) {
            console.warn('‚ö†Ô∏è Trends chart canvas not found');
            return;
        }

        // Prepare data
        const { labels, data } = this.prepareTrendsData();
        
        // Create gradient
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(124, 58, 237, 0.3)');
        gradient.addColorStop(1, 'rgba(124, 58, 237, 0.05)');

        // Destroy existing chart if exists
        if (this.charts.trends) {
            this.charts.trends.destroy();
        }

        this.charts.trends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Searches',
                    data: data,
                    borderColor: '#7c3aed',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#7c3aed',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#7c3aed',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: false,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed.y;
                                const plural = value === 1 ? 'search' : 'searches';
                                return `${value} ${plural}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(51, 65, 85, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#94a3b8',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            stepSize: 1,
                            callback: function(value) {
                                return Number.isInteger(value) ? value : '';
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        hoverRadius: 8
                    }
                }
            }
        });

        console.log('üìà Trends chart initialized');
    }

    async initDistributionChart() {
        const canvas = document.getElementById('distributionChart');
        if (!canvas) {
            console.warn('‚ö†Ô∏è Distribution chart canvas not found');
            return;
        }

        // Prepare data
        const { labels, data, colors, hasData } = this.prepareDistributionData();

        // Destroy existing chart if exists
        if (this.charts.distribution) {
            this.charts.distribution.destroy();
        }

        const ctx = canvas.getContext('2d');
        
        this.charts.distribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card') || '#1e293b',
                    borderWidth: 3,
                    hoverBorderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: true,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                if (!hasData) {
                                    return 'Start searching to see compliance distribution';
                                }
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} companies (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 1000
                }
            }
        });

        console.log('üç© Distribution chart initialized');
    }

    prepareTrendsData() {
        const dailySearches = this.data.daily_searches || [];
        
        if (dailySearches.length > 0) {
            const labels = dailySearches.map(item => {
                try {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    });
                } catch (e) {
                    return 'Invalid Date';
                }
            });
            
            const data = dailySearches.map(item => item.search_count || 0);
            
            return { labels, data };
        } else {
            // Generate sample data for empty state
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                data.push(0);
            }
            
            return { labels, data };
        }
    }

    prepareDistributionData() {
        const scoreDistribution = this.data.score_distribution || [];
        
        if (scoreDistribution.length > 0) {
            const hasData = scoreDistribution.some(item => (item.count || 0) > 0);
            
            if (hasData) {
                const labels = scoreDistribution.map(item => item.range || 'Unknown');
                const data = scoreDistribution.map(item => item.count || 0);
                const colors = [
                    '#10b981', // Excellent - Green
                    '#3b82f6', // Very Good - Blue
                    '#f59e0b', // Good - Yellow
                    '#f97316', // Average - Orange
                    '#ef4444'  // Poor - Red
                ];
                
                return { labels, data, colors, hasData: true };
            }
        }
        
        // No data state
        return {
            labels: ['No Data Available'],
            data: [1],
            colors: ['#475569'],
            hasData: false
        };
    }

    setupControls() {
        // Chart period buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from siblings
                const parent = e.target.closest('.chart-controls');
                if (parent) {
                    parent.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                }
                
                // Add active class to clicked button
                e.target.classList.add('active');
                
                const period = e.target.dataset.period;
                console.log('üìÖ Chart period changed to:', period);
                
                // Here you could implement period-based data loading
                // this.loadPeriodData(period);
            });
        });
    }

    setupCompanyInteractions() {
        // Company row click handlers
        document.addEventListener('click', (e) => {
            const companyRow = e.target.closest('.company-row');
            if (companyRow) {
                const gstin = companyRow.dataset.gstin;
                if (gstin) {
                    this.searchCompany(gstin);
                }
            }
        });
    }

    searchCompany(gstin) {
        if (gstin) {
            console.log('üîç Searching company:', gstin);
            window.location.href = `/search?gstin=${encodeURIComponent(gstin)}`;
        }
    }

    updateTimestamps() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-IN', { 
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = `Updated at ${timeString}`;
        }
    }

    showError(message) {
        // Show error notification
        console.error('Analytics error:', message);
        
        if (window.notificationManager) {
            window.notificationManager.show(message, 'error');
        }
    }

    showChartError() {
        // Show error in chart containers
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            const canvas = container.querySelector('canvas');
            if (canvas) {
                canvas.style.display = 'none';
                
                if (!container.querySelector('.chart-error')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chart-error';
                    errorDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Chart unavailable</p>
                        <button onclick="window.location.reload()" class="btn btn--sm">Retry</button>
                    `;
                    container.appendChild(errorDiv);
                }
            }
        });
    }

    // Public method to refresh data
    async refresh() {
        console.log('üîÑ Refreshing analytics data...');
        
        try {
            // Show loading state
            const liveIndicator = document.querySelector('.live-indicator');
            if (liveIndicator) {
                liveIndicator.classList.add('loading');
            }
            
            // Reload the page to get fresh data
            setTimeout(() => {
                window.location.reload();
            }, 500);
            
        } catch (error) {
            console.error('Refresh failed:', error);
            this.showError('Failed to refresh data');
        }
    }

    // Public method to destroy charts (cleanup)
    destroy() {
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        });
        this.charts = {};
        this.isInitialized = false;
        console.log('üßπ Analytics dashboard cleaned up');
    }
}

// Global functions for backward compatibility
// FIXED: Global navigation functions
window.searchCompany = function(gstin) {
    console.log('üîç Searching company:', gstin);
    
    if (!gstin) {
        console.error('No GSTIN provided');
        return;
    }
    
    // Clean the GSTIN
    const cleanGstin = gstin.toString().trim().toUpperCase();
    
    if (cleanGstin.length !== 15) {
        console.error('Invalid GSTIN length:', cleanGstin.length);
        if (window.notificationManager) {
            window.notificationManager.show('Invalid GSTIN format', 'error');
        }
        return;
    }
    
    // Show loading state if we're on dashboard
    const searchBtn = document.getElementById('search-btn');
    if (searchBtn) {
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Loading...</span>';
        searchBtn.disabled = true;
    }
    
    // Navigate to search results
    window.location.href = `/search?gstin=${encodeURIComponent(cleanGstin)}`;
};

// FIXED: Company row click handlers for history and analytics pages
document.addEventListener('click', function(e) {
    // Handle company row clicks
    const companyRow = e.target.closest('[data-gstin]');
    if (companyRow && companyRow.dataset.gstin) {
        // Don't trigger if clicking on a button or link inside the row
        if (e.target.closest('button, a, form')) {
            return;
        }
        
        const gstin = companyRow.dataset.gstin;
        console.log('Company row clicked:', gstin);
        window.searchCompany(gstin);
        return;
    }
    
    // Handle explicit search company calls
    const searchAction = e.target.closest('[onclick*="searchCompany"]');
    if (searchAction) {
        e.preventDefault();
        const onclickAttr = searchAction.getAttribute('onclick');
        const gstinMatch = onclickAttr.match(/searchCompany\(['"]([^'"]+)['"]\)/);
        if (gstinMatch && gstinMatch[1]) {
            window.searchCompany(gstinMatch[1]);
        }
        return;
    }
});

// FIXED: Form submission handlers for view buttons
document.addEventListener('submit', function(e) {
    // Handle search forms in history/analytics
    if (e.target.action && e.target.action.includes('/search')) {
        const gstinInput = e.target.querySelector('input[name="gstin"]');
        if (gstinInput && gstinInput.value) {
            console.log('Search form submitted with GSTIN:', gstinInput.value);
            // Let the form submit normally
            return;
        }
    }
});

// FIXED: Analytics page company search
window.refreshAnalytics = function() {
    if (window.analyticsDashboard) {
        window.analyticsDashboard.refresh();
    } else {
        window.location.reload();
    }
};

// Add debugging for navigation issues
console.log('üîß Navigation functions loaded');

// Test function for debugging
window.testNavigation = function(gstin) {
    console.log('Testing navigation with GSTIN:', gstin);
    window.searchCompany(gstin || '29AAAPL2356Q1ZS');
};

</script>
{% endblock %}

{% block extra_css %}
<style>
    /* FIXED Analytics Styles - Complete rewrite for better reliability */
    
    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .live-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse-dot 2s infinite ease-in-out;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .last-updated {
        margin-left: auto;
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    @keyframes pulse-dot {
        0%, 100% { 
            opacity: 1; 
            transform: scale(1);
        }
        50% { 
            opacity: 0.6; 
            transform: scale(1.2);
        }
    }

    /* Stats Grid - Enhanced */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        padding: 1.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--accent-gradient);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: var(--accent-primary);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        background: var(--accent-gradient);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    .stat-content {
        flex: 1;
        margin-left: 0.5rem;
    }

    .stat-value {
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1;
        margin-bottom: 0.375rem;
        letter-spacing: -0.025em;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        font-weight: 600;
    }

    .stat-change {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stat-change.positive {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .stat-change.neutral {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    /* Charts Grid - Enhanced */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 20px;
        padding: 1.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .chart-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-gradient);
        opacity: 0.6;
    }

    .chart-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.75rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-primary);
    }

    .chart-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .chart-title i {
        font-size: 1.1rem;
        color: var(--accent-primary);
    }

    .chart-controls {
        display: flex;
        gap: 0.375rem;
    }

    .chart-btn {
        padding: 0.5rem 1rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .chart-btn.active,
    .chart-btn:hover {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
    }

    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 1rem;
    }

    .chart-container canvas {
        border-radius: 12px;
    }

    .chart-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1.25rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .legend-item::before {
        content: '';
        width: 14px;
        height: 14px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    .legend-item.excellent::before { background: #10b981; }
    .legend-item.good::before { background: #3b82f6; }
    .legend-item.average::before { background: #f59e0b; }
    .legend-item.poor::before { background: #ef4444; }

    /* Companies List - Enhanced */
    .companies-list {
        max-height: 450px;
        overflow-y: auto;
        border-radius: 12px;
    }

    .companies-list::-webkit-scrollbar {
        width: 6px;
    }

    .companies-list::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 3px;
    }

    .companies-list::-webkit-scrollbar-thumb {
        background: var(--border-primary);
        border-radius: 3px;
    }

    .company-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .company-row:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
    }

    .company-row:last-child {
        border-bottom: none;
    }

    .company-info {
        flex: 1;
        margin-right: 1rem;
        min-width: 0;
    }

    .company-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.375rem;
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .company-gstin {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: 0.5px;
    }

    .company-stats {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-shrink: 0;
    }

    .search-count {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .search-count i {
        font-size: 0.75rem;
        color: var(--accent-primary);
    }

    .score-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        min-width: 60px;
        border: 2px solid transparent;
    }

    .score-excellent {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .score-good {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
        border-color: rgba(59, 130, 246, 0.3);
    }

    .score-average {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border-color: rgba(245, 158, 11, 0.3);
    }

    /* Empty State - Enhanced */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.4;
        color: var(--accent-primary);
    }

    .empty-state p {
        font-size: 1.1rem;
        margin: 0;
        font-weight: 500;
    }

    /* Insights Panel - Enhanced */
    .insights-panel {
        margin-top: 2rem;
    }

    .insight-card {
        display: flex;
        gap: 1.5rem;
        padding: 2rem;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .insight-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #f59e0b, #f97316);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .insight-content h4 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 1rem 0;
    }

    .insight-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .insight-content li {
        padding: 0.75rem 0;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
        border-bottom: 1px solid var(--border-primary);
    }

    .insight-content li:last-child {
        border-bottom: none;
    }

    /* Chart Error State */
    .chart-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 350px;
        color: var(--text-secondary);
        text-align: center;
    }

    .chart-error i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
        color: var(--error);
    }

    .chart-error p {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .chart-error .btn {
        padding: 0.5rem 1rem;
        background: var(--accent-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .chart-error .btn:hover {
        background: var(--accent-secondary);
        transform: translateY(-1px);
    }

    /* Loading States */
    .live-indicator.loading .live-dot {
        background: #f59e0b;
        animation: pulse-loading 1s infinite;
    }

    @keyframes pulse-loading {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design - Enhanced */
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .stat-card {
            padding: 1.25rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            font-size: 1.2rem;
        }

        .stat-value {
            font-size: 1.875rem;
        }

        .chart-card {
            padding: 1.25rem;
        }

        .chart-container {
            height: 280px;
        }

        .company-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
        }

        .company-stats {
            align-self: stretch;
            justify-content: space-between;
        }

        .insight-card {
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
        }

        .insight-icon {
            align-self: center;
        }
    }

    @media (max-width: 480px) {
        .charts-grid {
            gap: 1.5rem;
        }

        .chart-container {
            height: 250px;
        }

        .chart-controls {
            gap: 0.25rem;
        }

        .chart-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .legend-item {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}