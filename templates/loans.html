{% extends "base.html" %}

{% block title %}Business Loans - GST Intelligence Platform{% endblock %}

{% block extra_css %}
<style>
/* Additional loan-specific styles */
.loan-hero {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    padding: var(--space-16) 0;
    text-align: center;
    margin-bottom: var(--space-12);
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
    margin: var(--space-12) 0;
}

.feature-card {
    text-align: center;
    padding: var(--space-6);
}

.feature-icon {
    width: 64px;
    height: 64px;
    background: var(--accent-gradient);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-4);
    color: white;
    font-size: var(--text-2xl);
}

.loan-tabs {
    display: flex;
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-2);
    margin-bottom: var(--space-8);
    border: 1px solid var(--border-primary);
}

.loan-tab {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    background: none;
    border: none;
    border-radius: var(--radius-lg);
    color: var(--text-muted);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.loan-tab.active {
    background: var(--accent-gradient);
    color: white;
}

.loan-tab:hover:not(.active) {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.loan-status {
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending { background: var(--warning-light); color: var(--warning); }
.status-approved { background: var(--success-light); color: var(--success); }
.status-rejected { background: var(--error-light); color: var(--error); }
.status-disbursed { background: var(--info-light); color: var(--info); }

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-surface);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin: var(--space-3) 0;
}

.progress-fill {
    height: 100%;
    background: var(--accent-gradient);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
}

.emi-calculator {
    position: sticky;
    top: 80px;
}

@media (max-width: 768px) {
    .emi-calculator {
        position: static;
        margin-top: var(--space-6);
    }
    
    .loan-tabs {
        flex-direction: column;
    }
    
    .loan-tab {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block page_header %}
<div class="loan-hero">
    <div class="container">
        <h1>Business Loans</h1>
        <p class="page-subtitle">Get instant business loans based on your GST compliance</p>
        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3>Quick Approval</h3>
                <p>Get approval in 24 hours based on your GST compliance score</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <h3>Competitive Rates</h3>
                <p>Interest rates starting from 12% per annum for high-compliance businesses</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>No Collateral</h3>
                <p>Unsecured loans up to ₹50 lakhs without any collateral requirements</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Loan Management Tabs -->
    <div class="loan-tabs">
        <button class="loan-tab active" data-tab="eligibility">
            <i class="fas fa-check-circle"></i>
            Check Eligibility
        </button>
        <button class="loan-tab" data-tab="apply">
            <i class="fas fa-file-alt"></i>
            Apply for Loan
        </button>
        <button class="loan-tab" data-tab="applications">
            <i class="fas fa-list"></i>
            My Applications
        </button>
        <button class="loan-tab" data-tab="calculator">
            <i class="fas fa-calculator"></i>
            EMI Calculator
        </button>
    </div>

    <!-- Eligibility Check Tab -->
    <div id="eligibility-tab" class="tab-content active">
        <div class="grid grid-2" style="align-items: start;">
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-check-circle"></i>
                            Check Loan Eligibility
                        </h2>
                        <p class="card-text">Enter your business details to check loan eligibility instantly</p>
                    </div>
                    <div class="card-body">
                        <form id="eligibility-form">
                            <div class="form-group">
                                <label for="eligibility-gstin" class="form-label">GSTIN *</label>
                                <input type="text" id="eligibility-gstin" name="gstin" class="form-input" 
                                       placeholder="Enter your GSTIN" data-gstin-search required
                                       pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}">
                            </div>
                            
                            <div class="form-group">
                                <label for="eligibility-turnover" class="form-label">Annual Turnover (₹) *</label>
                                <input type="number" id="eligibility-turnover" name="annual_turnover" 
                                       class="form-input" placeholder="Enter annual turnover" 
                                       min="1000000" step="100000" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eligibility-compliance" class="form-label">Compliance Score (%)</label>
                                    <input type="number" id="eligibility-compliance" name="compliance_score" 
                                           class="form-input" placeholder="75" min="0" max="100" value="75">
                                </div>
                                
                                <div class="form-group">
                                    <label for="eligibility-vintage" class="form-label">Business Vintage (Months)</label>
                                    <input type="number" id="eligibility-vintage" name="business_vintage_months" 
                                           class="form-input" placeholder="12" min="1" value="12">
                                </div>
                            </div>
                            
                            <button type="button" id="check-eligibility" class="btn btn--primary btn--lg" 
                                    style="width: 100%;">
                                <i class="fas fa-search"></i>
                                Check Eligibility
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div>
                <div id="eligibility-result" class="card" style="display: none;">
                    <!-- Eligibility results will be populated here -->
                </div>
                
                <!-- Loan Requirements Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i>
                            Loan Requirements
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="requirement-list">
                            <div class="requirement-item">
                                <i class="fas fa-check text-success"></i>
                                <span>Minimum ₹10 lakh annual turnover</span>
                            </div>
                            <div class="requirement-item">
                                <i class="fas fa-check text-success"></i>
                                <span>60% minimum GST compliance score</span>
                            </div>
                            <div class="requirement-item">
                                <i class="fas fa-check text-success"></i>
                                <span>6 months minimum business vintage</span>
                            </div>
                            <div class="requirement-item">
                                <i class="fas fa-check text-success"></i>
                                <span>Active GST registration</span>
                            </div>
                            <div class="requirement-item">
                                <i class="fas fa-check text-success"></i>
                                <span>Regular GST filing history</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Application Tab -->
    <div id="apply-tab" class="tab-content">
        <div class="grid grid-3" style="align-items: start;">
            <div style="grid-column: 1 / 3;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-file-alt"></i>
                            Loan Application
                        </h2>
                        <p class="card-text">Complete your loan application in simple steps</p>
                    </div>
                    <div class="card-body">
                        <form id="loan-application-form">
                            <!-- Business Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="fas fa-building"></i>
                                    Business Information
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gstin" class="form-label">GSTIN *</label>
                                        <input type="text" id="gstin" name="gstin" class="form-input" 
                                               placeholder="Enter your GSTIN" data-gstin-search required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="company_name" class="form-label">Company Name *</label>
                                        <input type="text" id="company_name" name="company_name" 
                                               class="form-input" placeholder="Your company name" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="annual_turnover" class="form-label">Annual Turnover (₹) *</label>
                                        <input type="number" id="annual_turnover" name="annual_turnover" 
                                               class="form-input" placeholder="Enter annual turnover" 
                                               min="1000000" step="100000" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="monthly_revenue" class="form-label">Monthly Revenue (₹) *</label>
                                        <input type="number" id="monthly_revenue" name="monthly_revenue" 
                                               class="form-input" placeholder="Average monthly revenue" 
                                               min="50000" step="10000" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="compliance_score" class="form-label">GST Compliance Score (%)</label>
                                        <input type="number" id="compliance_score" name="compliance_score" 
                                               class="form-input" placeholder="Enter compliance score" 
                                               min="0" max="100" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="business_vintage_months" class="form-label">Business Vintage (Months) *</label>
                                        <input type="number" id="business_vintage_months" name="business_vintage_months" 
                                               class="form-input" placeholder="Business age in months" 
                                               min="6" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loan Details -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Loan Details
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="loan_amount" class="form-label">Loan Amount (₹) *</label>
                                        <input type="number" id="loan_amount" name="loan_amount" 
                                               class="form-input" placeholder="Enter required amount" 
                                               min="50000" max="5000000" step="10000" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="tenure_months" class="form-label">Loan Tenure *</label>
                                        <select id="tenure_months" name="tenure_months" class="form-input form-select" required>
                                            <option value="">Select tenure</option>
                                            <option value="6">6 months</option>
                                            <option value="12">12 months</option>
                                            <option value="18">18 months</option>
                                            <option value="24">24 months</option>
                                            <option value="36">36 months</option>
                                            <option value="48">48 months</option>
                                            <option value="60">60 months</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="purpose" class="form-label">Loan Purpose *</label>
                                    <select id="purpose" name="purpose" class="form-input form-select" required>
                                        <option value="">Select purpose</option>
                                        <option value="working_capital">Working Capital</option>
                                        <option value="equipment_purchase">Equipment Purchase</option>
                                        <option value="inventory_financing">Inventory Financing</option>
                                        <option value="business_expansion">Business Expansion</option>
                                        <option value="debt_consolidation">Debt Consolidation</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Terms and Conditions -->
                            <div class="form-section">
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="agree_terms" required>
                                        <span class="checkbox-custom"></span>
                                        I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> 
                                        and <a href="/privacy" target="_blank">Privacy Policy</a>
                                    </label>
                                </div>
                                
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="consent_credit_check" required>
                                        <span class="checkbox-custom"></span>
                                        I consent to credit bureau checks and information sharing with lending partners
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary btn--lg" style="width: 100%;">
                                    <i class="fas fa-paper-plane"></i>
                                    Submit Application
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="emi-calculator">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-calculator"></i>
                            EMI Calculator
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="calc-amount" class="form-label">Loan Amount (₹)</label>
                            <input type="number" id="calc-amount" class="form-input" 
                                   placeholder="5,00,000" min="50000" step="10000">
                        </div>
                        
                        <div class="form-group">
                            <label for="calc-tenure" class="form-label">Tenure (Months)</label>
                            <input type="number" id="calc-tenure" class="form-input" 
                                   placeholder="24" min="6" max="60">
                        </div>
                        
                        <div class="form-group">
                            <label for="calc-rate" class="form-label">Interest Rate (%)</label>
                            <input type="number" id="calc-rate" class="form-input" 
                                   placeholder="18" min="10" max="36" step="0.1">
                        </div>
                        
                        <div id="loan-calculation" class="calculator-result">
                            <!-- Calculation results will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Applications Tab -->
    <div id="applications-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-list"></i>
                    My Loan Applications
                </h2>
                <p class="card-text">Track the status of your loan applications</p>
            </div>
            <div class="card-body">
                <div id="loan-applications-list">
                    <!-- Applications will be loaded here -->
                    <div class="text-center" style="padding: var(--space-12);">
                        <i class="fas fa-file-alt" style="font-size: 3rem; color: var(--text-muted); margin-bottom: var(--space-4);"></i>
                        <p style="color: var(--text-muted);">Loading your loan applications...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EMI Calculator Tab -->
    <div id="calculator-tab" class="tab-content">
        <div class="grid grid-2" style="align-items: start;">
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-calculator"></i>
                            EMI Calculator
                        </h2>
                        <p class="card-text">Calculate your monthly EMI and total interest</p>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="calc-amount-main" class="form-label">Loan Amount (₹)</label>
                            <input type="range" id="calc-amount-range" min="50000" max="5000000" 
                                   step="10000" value="500000" class="range-input">
                            <input type="number" id="calc-amount-main" class="form-input" 
                                   min="50000" max="5000000" step="10000" value="500000">
                        </div>
                        
                        <div class="form-group">
                            <label for="calc-tenure-main" class="form-label">Tenure (Months)</label>
                            <input type="range" id="calc-tenure-range" min="6" max="60" 
                                   step="6" value="24" class="range-input">
                            <input type="number" id="calc-tenure-main" class="form-input" 
                                   min="6" max="60" value="24">
                        </div>
                        
                        <div class="form-group">
                            <label for="calc-rate-main" class="form-label">Interest Rate (%)</label>
                            <input type="range" id="calc-rate-range" min="10" max="36" 
                                   step="0.5" value="18" class="range-input">
                            <input type="number" id="calc-rate-main" class="form-input" 
                                   min="10" max="36" step="0.1" value="18">
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Loan Summary</h3>
                    </div>
                    <div class="card-body">
                        <div id="detailed-calculation" class="calculator-result">
                            <div class="result-item">
                                <span class="result-label">Monthly EMI</span>
                                <span class="result-value" id="emi-result">₹0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Total Interest</span>
                                <span class="result-value" id="interest-result">₹0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Total Amount</span>
                                <span class="result-value" id="total-result">₹0</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--space-6);">
                            <canvas id="emi-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.requirement-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.requirement-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-sm);
}

.text-success {
    color: var(--success);
}

.range-input {
    width: 100%;
    margin-bottom: var(--space-2);
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: var(--radius-full);
    background: var(--bg-surface);
    outline: none;
}

.range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: var(--radius-full);
    background: var(--accent-primary);
    cursor: pointer;
}

.range-input::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-full);
    background: var(--accent-primary);
    cursor: pointer;
    border: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.loan-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Update active tab button
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update active tab content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab + '-tab') {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Enhanced EMI Calculator with range inputs
    const amountRange = document.getElementById('calc-amount-range');
    const amountInput = document.getElementById('calc-amount-main');
    const tenureRange = document.getElementById('calc-tenure-range');
    const tenureInput = document.getElementById('calc-tenure-main');
    const rateRange = document.getElementById('calc-rate-range');
    const rateInput = document.getElementById('calc-rate-main');
    
    // Sync range and number inputs
    if (amountRange && amountInput) {
        amountRange.addEventListener('input', function() {
            amountInput.value = this.value;
            calculateDetailedEMI();
        });
        
        amountInput.addEventListener('input', function() {
            amountRange.value = this.value;
            calculateDetailedEMI();
        });
    }
    
    if (tenureRange && tenureInput) {
        tenureRange.addEventListener('input', function() {
            tenureInput.value = this.value;
            calculateDetailedEMI();
        });
        
        tenureInput.addEventListener('input', function() {
            tenureRange.value = this.value;
            calculateDetailedEMI();
        });
    }
    
    if (rateRange && rateInput) {
        rateRange.addEventListener('input', function() {
            rateInput.value = this.value;
            calculateDetailedEMI();
        });
        
        rateInput.addEventListener('input', function() {
            rateRange.value = this.value;
            calculateDetailedEMI();
        });
    }
    
    function calculateDetailedEMI() {
        const principal = parseFloat(amountInput?.value) || 0;
        const tenure = parseInt(tenureInput?.value) || 0;
        const rate = parseFloat(rateInput?.value) || 0;
        
        if (principal && tenure && rate) {
            const monthlyRate = rate / 100 / 12;
            const emi = (principal * monthlyRate * Math.pow(1 + monthlyRate, tenure)) / 
                        (Math.pow(1 + monthlyRate, tenure) - 1);
            const totalAmount = emi * tenure;
            const totalInterest = totalAmount - principal;
            
            // Update results
            const emiResult = document.getElementById('emi-result');
            const interestResult = document.getElementById('interest-result');
            const totalResult = document.getElementById('total-result');
            
            if (emiResult) emiResult.textContent = formatCurrency(emi);
            if (interestResult) interestResult.textContent = formatCurrency(totalInterest);
            if (totalResult) totalResult.textContent = formatCurrency(totalAmount);
        }
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }
    
    // Auto-calculate form validation
    const loanAmountInput = document.getElementById('loan_amount');
    const annualTurnoverInput = document.getElementById('annual_turnover');
    
    if (loanAmountInput && annualTurnoverInput) {
        function validateLoanAmount() {
            const loanAmount = parseFloat(loanAmountInput.value) || 0;
            const annualTurnover = parseFloat(annualTurnoverInput.value) || 0;
            
            if (loanAmount && annualTurnover) {
                const maxLoan = annualTurnover * 0.5; // 50% of turnover
                
                if (loanAmount > maxLoan) {
                    loanAmountInput.setCustomValidity(`Loan amount cannot exceed 50% of annual turnover (₹${formatNumber(maxLoan)})`);
                } else {
                    loanAmountInput.setCustomValidity('');
                }
            }
        }
        
        loanAmountInput.addEventListener('input', validateLoanAmount);
        annualTurnoverInput.addEventListener('input', validateLoanAmount);
    }
    
    function formatNumber(num) {
        return new Intl.NumberFormat('en-IN').format(num);
    }
    
    // Pre-fill form from eligibility data
    const eligibilityForm = document.getElementById('eligibility-form');
    const applicationForm = document.getElementById('loan-application-form');
    
    if (eligibilityForm && applicationForm) {
        // Listen for changes in eligibility form
        eligibilityForm.addEventListener('input', function() {
            const gstinValue = document.getElementById('eligibility-gstin')?.value;
            const turnoverValue = document.getElementById('eligibility-turnover')?.value;
            const complianceValue = document.getElementById('eligibility-compliance')?.value;
            const vintageValue = document.getElementById('eligibility-vintage')?.value;
            
            // Auto-fill application form
            if (gstinValue) {
                const appGstin = document.getElementById('gstin');
                if (appGstin) appGstin.value = gstinValue;
            }
            
            if (turnoverValue) {
                const appTurnover = document.getElementById('annual_turnover');
                if (appTurnover) appTurnover.value = turnoverValue;
                
                // Estimate monthly revenue
                const monthlyRevenue = document.getElementById('monthly_revenue');
                if (monthlyRevenue && !monthlyRevenue.value) {
                    monthlyRevenue.value = Math.round(turnoverValue / 12);
                }
            }
            
            if (complianceValue) {
                const appCompliance = document.getElementById('compliance_score');
                if (appCompliance) appCompliance.value = complianceValue;
            }
            
            if (vintageValue) {
                const appVintage = document.getElementById('business_vintage_months');
                if (appVintage) appVintage.value = vintageValue;
            }
        });
    }
    
    // Initial calculation
    calculateDetailedEMI();
});
</script>
{% endblock %}